title: 机智云通用串口协议解析
---

# 1、前言

协议主要分三部分：基本通信协议、扩展通信协议和网关扩展协议。第一，基本通信协议上面的内容，所有的mcu端开发者都要完成上面的协议；第二，扩展通信协议，是可选择完成的协议，上面主要提供的功能是大数据传输，要做mcu ota 升级的功能，就要完成上面的协议。第三，网关扩展协议，主要是做轻网关方案项目的产品，如果产品是做网关方案的，如蓝牙Mesh，就需要完成上面的协议。

# 2、协议下载流程

### 2.1根据已经创建好的产品，并且定义好数据点，选中产品

![name](/assets/zh-cn/deviceDev/debug/NB_project/000000000000000000000.png)

### 2.2下载模组与mcu之间的串口通信协议

![name](/assets/zh-cn/deviceDev/debug/NB_project/000000000000000000000.png)

# 3、协议内容说明

### 3.1

mcu与WiFi模组通过串口交互，通用固件：波特率9600/数据位8位、无奇偶校验/停止位1位/无数据流控。数据帧格式如下：

| 字段  | 长度(byte) | 内容说明 |
| ------------- | ------------- | ------------- |
| 固定包头  | 2 | 固定0xFFFF |
| 包长度  | 2  | len(命令...校验和) |
| 命令  | 1  | 具体指令 |
| 包序号  | 1  | 对应发送包的包序号 |
| flags  | 2  | 固定0x0000 |
| 业务  | xxxx  | 根据具体指令查看 |
| 校验和  | 1  |  |

基本通信协议部分WiFi模组和mcu命令表如下：

| 发起端=>接收端  | WiFi模组命令 | mcu命令字 | 说明 |
| ------------- | ------------- | ------------- | ------------- |
| WiFi=>mcu  | 0x01  | 0x02 | 获取设备信息 |
| WiFi=>mcu  | 0x0d  | 0x0e | 推送WiFi模组工作状态 |
| WiFi=>mcu  | 0x07  | 0x08 | 心跳 |
| mcu=>WiFi  | 0x0a  | 0x09 | 通知WiFi模组进入配网模式 |
| WiFi=>mcu  | 0x03  | 0x04 | WiFi模组读取设备的当前状态（与WiFi模组控制设备的区别是通过action位字段来区别，WiFi模组读取设备的当前状态action位02，而WiFi模组控制设备action位为01） |
| WiFi=>mcu  | 0x03  | 0x04 | WiFi模组控制设备 |
| mcu=>WiFi  | 0x05  | 0x06 | 设备MCU向WiFi模组主动上报当前状态 |
| mcu=>WiFi  | 0x0b  | 0x0c | 重置WiFi模组，或者说给WiFi模组恢复出厂设置。 |

此外，机智云串口通信协议的数据传输方式有两种：定长和变长。

* 定长和变长功能上的区别：

（1）定长方式是“3.4 设备mcu向WiFi模组主动上报当前状态”上面的attr_flags和dev_status 序号的数据，全部都要上传。

（2）变长方式是“3.4 设备mcu向WiFi模组主动上报当前状态”上面的attr_flags和dev_status 序号的数据，只需要上报设备状态改变的。

* 定长和变长指令上的区别，主要是以下三个协议上面的action位不一样。

##### 3.2 WiFi模组控制设备
##### 3.3 WiFi模组读取设备的当前状态
##### 3.4 设备MCU向WiFi模组主动上报当前状态

| 协议  | 发起端=>接收端 | 定长的action位 | 变长的action位 |
| ------------- | ------------- | ------------- | ------------- |
| 3.2  | WiFi->mcu  | 0x01 | 0x11 |
| 3.3  | WiFi->mcu  | 0x02 | 0x12 |
| 3.3  | mcu->Wifi  | 0x03 | 0x13 |
| 3.4  | mcu->Wifi  | 0x04 | 0x14 |

### 3.2基本通信协议

根据串口协议《3.基本通讯协议(必须)》上面的指令，mcu嵌入式开发流程。

#### (1)APP配置WiFi模组连接云端流程（必须开发）

以下3个指令是模组与mcu串口握手成功之后，会依次发送出来的。

##### · 3.1获取设备信息
##### · 3.8推送WiFi模组工作状态
##### · 3.5心跳

然后，人为触发mcu请求WiFi模组进入配网模式。

##### · 3.6通知WiFi模组进入配网模式

具体流程可以查看以下时序图：

![name](/assets/zh-cn/deviceDev/debug/NB_project/000000000000000000000.png)

此外，如果通信模组不是WiFi模组，而是2G、4G或者NB模组的话，mcu不需要请求WiFi模组进入配网模式。2G/4G/NB模组是无线蜂窝通信模组，只要给设备插上物联网卡，模组根据蜂窝通信方式连接附近的基站，从而再连接上机智云平台。

#### (2)APP获取设备当前状态（必须开发）

主要用到的指令如下：

##### · 3.3WiFi模组读取设备的当前状态

具体流程可以查看以下时序图：

![name](/assets/zh-cn/deviceDev/debug/NB_project/000000000000000000000.png)

#### (3)APP下发控制指令（必须开发）

主要用到的指令如下：

##### · 3.2 WiFi模组控制设备

##### · 3.4 设备mcu向WiFi模组主动上报当前状态

具体流程可以查看以下时序图：

![name](/assets/zh-cn/deviceDev/debug/NB_project/000000000000000000000.png)

#### (4)非法包处理（必须开发）

主要命令如下：

##### · 3.9非法数据包通知

该包是模组发送出来的mcu回复即可。

#### (5)重置WiFi模组（必须开发）

主要命令如下：

##### · 3.7重置WiFi模组

该功能相当于给WiFi模组恢复出厂设置，所以，硬件开发的时候一定要开发该功能。

#### (6)可绑定模式（可选功能，可不开发）

主要命令如下：

##### · 3.10 mcu通知WiFi模组进入可绑定模式

如果“3.1获取设备信息”中的序号11 “可绑定状态失效时间”填写的是非0，如填写600秒，就是说明APP配网设备后，要在10分钟的时间内进行绑定，否则，就要重新配网或者mcu发出3.10 mcu通知WiFi模组进入可绑定模式。

#### (7)MCU重启WiFi模组（可选功能，可不开发）

主要命令如下：

##### · 3.11 MCU重启通信模组

该指令应用再mcu ota升级流程上面，“3.3.扩展通信协议”下面会细说。

### 3.3.扩展通信协议

#### (1)重启MCU（不需要开发）

主要命令如下：

##### · "4.1 重启MCU"

忽略该指令，mcu开发程序不需要处理。

#### (2)产测功能(可选功能，可不开发)

主要命令如下：

##### · "4.2 MCU请求WiFi模组进入产测模式"

可选指令，如果产品不需要进行产测功能，可以不开发该功能。该产测是机智云产品产测方案：具体流程如链接：docs.gizwits.com/zh-cn/deviceDev/产测工具使用文档.html

#### (3)获取网络时间（可选功能，可不开发）

主要命令如下：

##### · "4.3.MCU请求获取网络时间"

可选指令，如果产品不需要通过设备显示网络时间，可以不开发该功能。

该指令获取网络时间的时区为模组设定的默认时区查看“3.1获取设备信息”->“Data”->"8.tz:设备默认时区",如果mcu开发没有填该时区，模组默认为北京时间。如果设备是全球化设备，会根据APP配网的时候下发的时区为准，如：手机APP配网的时候用的是“纽约”时区，那这里mcu回去的网络时间就为“纽约”时间。

如果mcu程序需要对时间自行转换，可以根据“4.3.MCU请求获取网络时间”->"NTP时间"上面的时间戳，来自行转换。

注意：如果设备一上电就要去获取网络时间来校对，要先判断设备是否连接上云端，判断设备已经连接上云端后，再请求获取网络时间，否则获取的时间都为0的。

#### (4)mcu ota功能（可选功能，可不开发）

主要命令如下：

##### · 4.4.大数据下发：数据发起这请求向数据接收者发送大数据
##### · 4.5.大数据下发：数据接收者告知数据发起这可以开始发送数据
##### · 4.6.大数据下发：数据发送者向数据接收者下发数据分片
##### · 4.7.大数据下发：数据发起者向数据接收者通知取消数据下发
##### · 4.8.大数据下发：数据接收者向数据发起者通知取消数据下发
##### · 3.11 MCU重启WiFi模组

具体流程时序图：

![name](/assets/zh-cn/deviceDev/debug/NB_project/000000000000000000000.png)

备注说明：

###### 1.mcu ota 升级数据发起者是WiFi模组，数据接收者是MCU

###### 2.“2.4.4.大数据下发：数据发起这请求向数据接收者发送大数据”

WiFi模组给MCU发送的，MCU只需要按照协议回复ACK（ACK为应答包，表示我已经收到请求了）

###### 3.“4.5.大数据下发：数据接收者告知数据发起这可以开始发送数据”

MCU给WiFi模组发送的，MCU按照协议格式规定告知WiFi模组，关于OTA大文件，WiFi模组应该以多大一片下发给MCU，以及分片的大小建议为128B。

###### 4.“ 4.6.大数据下发：数据发送者向数据接收者下发数据分片”

WiFi模组给MCU发送的，WiFi模组按照“4.5.大数据下发：数据接收者告知数据发起这可以开始发送数据”MCU回复的分片大小，一片片给MCU发送。MCU只需要回复WiFi模组下发的每一包数据，如果其中有一包不回复，WiFi模组会从发2次数。如果MCU都不回复，WiFi模组就视为不再接受该包，这个MCU OTA就会失败。

###### 5.“3.11 MCU重启WiFi模组”

MCU给WiFi模组发送的，当MCU已经接收完成“4.6.大数据下发：数据发送者向数据接收者下发数据分片”后，按照MCU先前规划好的flash寻址，进行MCU本地升级。升级完成后，注意一定要请求“MCU重启WiFi模组”。这样做的原因：这样做是为了WiFi模块重新给mcu进行握手的时候，获取到的mcu版本号为新版的版本号，然后但WiFi模块重新连接上云端后，会进行ota版本校对，如果这时云端拿到的mcu软件版本号和云端填写的一样，云端就提示mcu ota固件验证成功或者是该次mcu ota推送成功。 

###### 6.“4.7.大数据下发：数据发起者向数据接收者通知取消数据下发”

WiFi模组给MCU发送的，MCU只要按照协议做ACK回复即可。

###### 7.“4.8.大数据下发：数据接收者向数据发起者通知取消数据下发”

MCU给WiFi模组发送的，该指令一般应用到WiFi模组下发的MCU OTA固件，MCU的flash不够，所以MCU检查到就可以发送这个指令。

#### (5)MCU获取WiFi模组的信息（可选功能，可不开发）

主要命令如下：

##### · 4.9.MCU获取通讯模组的信息

具体流程时序图：

MCU给WiFi模组发送的，MCU可以按照协议向WiFi模组获取“WiFi模组硬件版本号”、“WiFi模组软件版本号”、“WiFi模组MAC”和“WiFi模组IP”。

### 3.4.网关扩展协议

#### (1)机智云轻网关方案（可选功能，非轻网关产品，可忽略）

目前轻网关方案，我们只支持用乐鑫8266模组，并且固件版本为04020035版本以上（包括04020035版本），其它模组暂时不支持。轻网关方案存在 4 个位置：模组 SDK、移动端 SDK、云端接入层、客户应用层。机智云串口协议部分为WiFi转网关部分，如下图的WiFi转蓝牙网关。


![name](/assets/zh-cn/deviceDev/debug/NB_project/000000000000000000000.png)

轻网关主要指令如下：

###### · 5.1MCU向通知WiFi模组请求子设备请求注册
###### · 5.2通讯模组向MCU发送子设备注册结果通知
###### · 5.3 MCU向通讯模组发送子设备上下线状态同步
###### · 5.4 通讯模组向MCU发送子设备的业务指令
###### · 5.5 MCU向通讯模组发送子设备的业务指令
###### · 5.7App通知网关删除子设备指令

##### a.网关与子设备通信方式是有线方式

如果子设备与网关之间通信是通过有线连接方式，如433/458等方式，注册子设备就要通过mcu请求WiFi模组完成。轻网关控制子设备时序图如下：

![name](/assets/zh-cn/deviceDev/debug/NB_project/000000000000000000000.png)

##### b.网关与子设备通信方式是无线方式

如果子设备与网关之间通信是通过无线连接方式，如蓝牙mesh、红外等方式，注册子设备通过APP注册子设备接口来完成。轻网关控制子设备时序图如下：

![name](/assets/zh-cn/deviceDev/debug/NB_project/000000000000000000000.png)

备注说明：

###### 1.“5.1MCU向通知WiFi模组请求子设备请求注册”

MCU给WiFi模组发送的，如果产品子设备注册请求已经通过APP来完成，该指令可以忽略。
该指令一般应用在网关与子设备之间的通信是通过433、232、485等本地串口方式，就可以通过这种方式来注册子设备。如果网关与子设备之间的通信是通过蓝牙、红外等无线方式，就直接用APP方式在注册子设备。

###### 2."5.2通讯模组向MCU发送子设备注册结果通知"

WiFi模组给MCU发送的，这个指令是与“ 5.1MCU向通知WiFi模组请求子设备请求注册”一起使用，MCU按照协议回复的数据，判断子设备是否注册成功。然后，MCU在做自己的应用处理。

###### 3."5.3 MCU向通讯模组发送子设备上下线状态同步"

MCU给WiFi模组发送的，网关按照已子设备的通信，把子设备在线或者离线状态给网关发送，然后MCU在根据网关收集的子设备在线或离线状态，给WiFi模组发送。

###### 4."5.4 通讯模组向MCU发送子设备的业务指令"

WiFi模组给MCU发送的，WiFi模组给MCU发送子设备的业务指令，MCU只需要按照协议回复WiFi模组ACK，表示我已经收到了指令。然后再去执行，下面的“5.5 MCU向通讯模组发送子设备的业务指令”

###### 5."5.5 MCU向通讯模组发送子设备的业务指令"

MCU给WiFi模组发送的，MCU收到“5.4 通讯模组向MCU发送子设备的业务指令”后，然后按照上面的业务指令，如把xxx子设备打开。网关处理完成完成上面的业务指令，然后mcu收集到网关该子设备的状态，然后通过“5.5 MCU向通讯模组发送子设备的业务指令”上报给WiFi模组。

###### 6."5.7App通知网关删除子设备指令"

WiFi模组给MCU发送的，该指令是WiFi模组告知MCU，相关的子设备已经用户通过APP删除了，网关本地也要把该子设备从网关删除掉，然后在上报当前所以子设备的上下线状态指令“ 5.3 MCU向通讯模组发送子设备上下线状态同步”。

#### (2)非机智云轻网关方案（可选功能，可不开发）

如果客户使用的是非机智云轻网关方案，只要指令如下：

###### · 5.6 透传业务指令

WiFi模组给MCU发送指令以及MCU设备向App透传业务指令，该指令给机智云轻网关方案没有关系，只有是用在一些没有按照机智云轻网关方案开发的中控产品上面。上面的业务指令，MCU可以按照原来协定好的规则来处理。

# 4、FAQ

Q:WiFi模组给mcu下发控制指令，为什么APP端状态没有改变？

W:分析，查看mcu不是只回复“3.2 WiFi模组控制设备”指令，并没有改变当前设备状态，并且把状态发送上来“3.4 设备mcu向WiFi模组主动上报当前状态”。
